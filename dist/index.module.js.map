{"version":3,"file":"index.module.js","sources":["../src/index.js"],"sourcesContent":["import { useState, useEffect, useReducer, useRef } from 'react';\n\nexport const encryptData = async (data, encrypted, keys, sea) => {\n  return encrypted ? sea.encrypt(data, keys) : Promise.resolve(data);\n};\n\nexport const decryptData = async (data, encrypted, keys, sea) => {\n  return encrypted ? sea.decrypt(data, keys) : Promise.resolve(data);\n};\n\nconst debouncedUpdates = (dispatcher, timeout = 100) => {\n  let actions = [];\n  let handler;\n  return (action) => {\n    actions.push(action);\n    if (!handler) {\n      handler = setTimeout(() => {\n        let newStateSlice = actions.reduce((previousState, { id, data }) => {\n          previousState[id] = data;\n          return previousState;\n        }, {});\n        dispatcher(newStateSlice);\n        actions = [];\n        handler = null;\n      }, timeout);\n    }\n\n    return () => {\n      clearTimeout(handler);\n      actions = [];\n      handler = null;\n    };\n  };\n};\n\nconst reducer = (state, { data, type }) => {\n  switch (type) {\n    case 'add':\n      return { ...state, ...data };\n    case 'update':\n      return { ...state, [data.nodeID]: data };\n    case 'remove':\n      delete state[data];\n      return { ...state };\n    default:\n      throw new Error();\n  }\n};\n\nconst useIsMounted = () => {\n  const isMounted = useRef(false);\n  useEffect(() => {\n    isMounted.current = true;\n    return () => (isMounted.current = false);\n  }, []);\n  return isMounted;\n};\n\nconst useSafeReducer = (reducer, initialState) => {\n  const [state, dispatch] = useReducer(reducer, initialState);\n  const isMounted = useIsMounted();\n\n  function safeDispatch(args) {\n    if (isMounted.current) {\n      dispatch(args);\n    }\n  }\n\n  return [state, safeDispatch];\n};\n\nexport const useGun = (Gun, peerList) => {\n  const [gun] = useState(\n    Gun({\n      peers: peerList,\n    })\n  );\n\n  return [gun];\n};\n\nexport const useGunNamespace = (gun) => {\n  const [namespace, setNamespace] = useState(null);\n  if (!namespace) {\n    setNamespace(gun.user());\n  }\n  return [namespace];\n};\n\nexport const useGunKeyAuth = (gun, keys, triggerAuth = true) => {\n  // Will attempt to perform a login (when triggerAuth is set to true),\n  // or, if false, returns a namespaced gun node\n  const [namespacedGraph] = useGunNamespace(gun);\n  const [isLoggedIn, setIsLoggedIn] = useState(false);\n\n  gun.on('auth', () => {\n    setIsLoggedIn(true);\n  });\n\n  useEffect(() => {\n    if (namespacedGraph && !namespacedGraph.is && keys && triggerAuth) {\n      namespacedGraph.auth(keys);\n    }\n  }, [triggerAuth, namespacedGraph, keys]);\n\n  return [namespacedGraph, isLoggedIn];\n};\n\nexport const useGunKeys = (sea, initialValue) => {\n  const [keys, setKeys] = useState(initialValue);\n\n  async function getKeySet() {\n    const pair = await sea.pair();\n    setKeys(pair);\n  }\n\n  if (!keys) {\n    getKeySet();\n  }\n\n  return [keys, setKeys];\n};\n\nexport const useGunState = (\n  ref,\n  { appKeys, sea, interval = 100, encrypted = true }\n) => {\n  const [gunAppGraph] = useState(ref);\n  const [fields, dispatch] = useSafeReducer(reducer, {});\n  const handler = useRef(null);\n  const isMounted = useIsMounted();\n\n  useEffect(() => {\n    const debouncedHandlers = [];\n    if (isMounted.current) {\n      const updater = debouncedUpdates((data) => {\n        dispatch({ type: 'add', data });\n      }, interval);\n\n      gunAppGraph.on(async (encryptedField, nodeID, message, event) => {\n        let decryptedField = await decryptData(\n          encryptedField,\n          encrypted,\n          appKeys,\n          sea\n        );\n        Object.keys(decryptedField).forEach((key) => {\n          let cleanFn = updater({ id: key, data: decryptedField[key] });\n          debouncedHandlers.push(cleanFn);\n        });\n\n        if (!handler.current) {\n          handler.current = event;\n        }\n      });\n    }\n\n    return () => {\n      if (handler.current) {\n        //cleanup gun .on listener\n        handler.current.off();\n      }\n      if (debouncedHandlers.length) {\n        //cleanup timeouts\n        debouncedHandlers.forEach((c) => c());\n      }\n    };\n    // We just need to set the listener once\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Working with root node fields\n  const put = async (data) => {\n    let encryptedData = await encryptData(data, encrypted, appKeys, sea);\n    await gunAppGraph.put(encryptedData);\n  };\n\n  const remove = async (field) => {\n    await gunAppGraph.put(null);\n    dispatch({ type: 'remove', data: field });\n  };\n\n  return [\n    fields,\n    { put, remove },\n    gunAppGraph, // the actual graph is sent in case something advanced needs to be done\n  ];\n};\n\nexport function useGunCollectionState(\n  ref,\n  { appKeys, sea, interval = 100, encrypted = true }\n) {\n  const [gunAppGraph] = useState(ref);\n  const [collection, dispatch] = useSafeReducer(reducer, {});\n  const handler = useRef(null);\n  const isMounted = useIsMounted();\n\n  // Working with Sets\n  useEffect(() => {\n    const debouncedHandlers = [];\n    if (isMounted.current) {\n      const updater = debouncedUpdates((data) => {\n        dispatch({ type: 'add', data });\n      }, interval);\n\n      gunAppGraph.map().on(async (encryptedNode, nodeID, message, event) => {\n        let item = await decryptData(encryptedNode, encrypted, appKeys, sea);\n        if (item) {\n          let cleanFn = updater({\n            id: nodeID,\n            data: { ...item, nodeID },\n          });\n          debouncedHandlers.push(cleanFn);\n        }\n\n        if (!handler.current) {\n          handler.current = event;\n        }\n      });\n    }\n\n    return () => {\n      if (handler.current) {\n        //cleanup gun .on listener\n        handler.current.off();\n      }\n      if (debouncedHandlers.length) {\n        //cleanup timeouts\n        debouncedHandlers.forEach((c) => c());\n      }\n    };\n    // We just need to set the listener once\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const updateInSet = async (nodeID, data) => {\n    let encryptedData = await encryptData(data, encrypted, appKeys, sea);\n    await gunAppGraph.get(nodeID).put(encryptedData);\n    dispatch({ type: 'update', data: { nodeID, ...data } });\n  };\n\n  const addToSet = async (data) => {\n    let encryptedData = await encryptData(data, encrypted, appKeys, sea);\n    await gunAppGraph.set(encryptedData);\n  };\n\n  const removeFromSet = async (nodeID) => {\n    await gunAppGraph.get(nodeID).put(null);\n    dispatch({ type: 'remove', data: nodeID });\n  };\n\n  return [\n    collection,\n    { addToSet, updateInSet, removeFromSet },\n    gunAppGraph, // the actual graph is sent in case something advanced needs to be done\n  ];\n}\n"],"names":["encryptData","data","encrypted","keys","sea","encrypt","decryptData","decrypt","debouncedUpdates","dispatcher","timeout","handler","actions","action","push","setTimeout","newStateSlice","reduce","previousState","clearTimeout","reducer","state","Object","nodeID","Error","useIsMounted","isMounted","useRef","useEffect","current","useSafeReducer","initialState","useReducer","args","dispatch","useGun","Gun","peerList","useState","peers","useGunNamespace","gun","namespace","setNamespace","user","useGunKeyAuth","triggerAuth","on","setIsLoggedIn","namespacedGraph","is","auth","isLoggedIn","useGunKeys","initialValue","pair","setKeys","getKeySet","useGunState","ref","debouncedHandlers","updater","type","interval","gunAppGraph","encryptedField","message","event","appKeys","decryptedField","forEach","key","cleanFn","id","off","length","c","fields","encryptedData","put","field","useGunCollectionState","map","encryptedNode","item","collection","set","get"],"mappings":"gFAEaA,WAAqBC,EAAMC,EAAWC,EAAMC,8BAChDF,EAAYE,EAAIC,QAAQJ,EAAME,GAAwBF,uCAGlDK,WAAqBL,EAAMC,EAAWC,EAAMC,8BAChDF,EAAYE,EAAIG,QAAQN,EAAME,GAAwBF,uCAGzDO,WAAoBC,EAAYC,kBAAU,SAE1CC,EADAC,EAAU,mBAENC,UACND,EAAQE,KAAKD,GACRF,IACHA,EAAUI,0BACJC,EAAgBJ,EAAQK,gBAAQC,YAClCA,eACOA,GACN,IACHT,EAAWO,GACXJ,EAAU,GACVD,EAAU,MACTD,eAIHS,aAAaR,GACbC,EAAU,GACVD,EAAU,QAKVS,WAAWC,uCAER,aACIC,iBAAKD,EAAUpB,OACnB,gBACIqB,iBAAKD,UAAQpB,EAAKsB,QAAStB,UAC/B,uBACIoB,EAAMpB,GACNqB,iBAAKD,iBAEN,IAAIG,QAIVC,iBACEC,EAAYC,GAAO,UACzBC,oBACEF,EAAUG,SAAU,oBACNH,EAAUG,SAAU,IACjC,IACIH,GAGHI,WAAkBV,EAASW,SACLC,EAAWZ,EAASW,iBACxCL,EAAYD,UAQX,CAACJ,WANcY,GAChBP,EAAUG,SACZK,EAASD,MAOFE,WAAUC,EAAKC,SAOnB,CANOC,EACZF,EAAI,CACFG,MAAOF,UAOAG,WAAmBC,SACIH,EAAS,oBACtCI,IACHC,QAAaF,EAAIG,QAEZ,CAACF,IAGGG,WAAiBJ,EAAKtC,EAAM2C,mBAAc,SAG3BN,EAAgBC,QACNH,GAAS,wBAE7CG,EAAIM,GAAG,kBACLC,GAAc,KAGhBpB,aACMqB,IAAoBA,EAAgBC,IAAM/C,GAAQ2C,GACpDG,EAAgBE,KAAKhD,IAEtB,CAAC2C,EAAaG,EAAiB9C,IAE3B,CAAC8C,EAAiBG,IAGdC,WAAcjD,EAAKkD,SACNhB,EAASgB,wBAO5BnD,kCAJgBC,EAAImD,sBAAjBA,GACNC,EAAQD,wCAIRE,GAGK,CAACtD,EAAMqD,IAGHE,WACXC,yDAC2B,uCAAiB,SAEtBrB,EAASqB,QACJ7B,EAAeV,EAAS,kBAC7CT,EAAUgB,EAAO,MACjBD,EAAYD,WAElBG,iBACQgC,EAAoB,MACtBlC,EAAUG,QAAS,KACfgC,EAAUrD,WAAkBP,GAChCiC,EAAS,CAAE4B,KAAM,WAAO7D,KACvB8D,GAEHC,EAAYjB,YAAUkB,EAAgB1C,EAAQ2C,EAASC,8BAC1B7D,EACzB2D,EACA/D,EACAkE,EACAhE,kBAJEiE,GAMJ/C,OAAOnB,KAAKkE,GAAgBC,iBAASC,OAC/BC,EAAUX,EAAQ,CAAEY,GAAIF,EAAKtE,KAAMoE,EAAeE,KACtDX,EAAkB9C,KAAK0D,KAGpB7D,EAAQkB,UACXlB,EAAQkB,QAAUsC,4DAMlBxD,EAAQkB,SAEVlB,EAAQkB,QAAQ6C,MAEdd,EAAkBe,QAEpBf,EAAkBU,iBAASM,UAAMA,QAKpC,IAaI,CACLC,EACA,cAZiB5E,8BACSD,EAAYC,EAAMC,EAAWkE,EAAShE,kBAA5D0E,0BACEd,EAAYe,IAAID,6EAGFE,8BACdhB,EAAYe,IAAI,uBACtB7C,EAAS,CAAE4B,KAAM,SAAU7D,KAAM+E,2CAMjChB,IAIG,SAASiB,EACdtB,yDAC2B,uCAAiB,SAEtBrB,EAASqB,QACA7B,EAAeV,EAAS,kBACjDT,EAAUgB,EAAO,MACjBD,EAAYD,WAGlBG,iBACQgC,EAAoB,MACtBlC,EAAUG,QAAS,KACfgC,EAAUrD,WAAkBP,GAChCiC,EAAS,CAAE4B,KAAM,WAAO7D,KACvB8D,GAEHC,EAAYkB,MAAMnC,YAAUoC,EAAe5D,EAAQ2C,EAASC,8BACzC7D,EAAY6E,EAAejF,EAAWkE,EAAShE,kBAA5DgF,MACAA,EAAM,KACJZ,EAAUX,EAAQ,CACpBY,GAAIlD,EACJtB,KAAMqB,iBAAK8D,UAAM7D,MAEnBqC,EAAkB9C,KAAK0D,GAGpB7D,EAAQkB,UACXlB,EAAQkB,QAAUsC,4DAMlBxD,EAAQkB,SAEVlB,EAAQkB,QAAQ6C,MAEdd,EAAkBe,QAEpBf,EAAkBU,iBAASM,UAAMA,QAKpC,IAkBI,CACLS,EACA,mBAZsBpF,8BACID,EAAYC,EAAMC,EAAWkE,EAAShE,kBAA5D0E,0BACEd,EAAYsB,IAAIR,kFARGvD,EAAQtB,8BACPD,EAAYC,EAAMC,EAAWkE,EAAShE,kBAA5D0E,0BACEd,EAAYuB,IAAIhE,GAAQwD,IAAID,oBAClC5C,EAAS,CAAE4B,KAAM,SAAU7D,KAAMqB,yBAAEC,GAAWtB,oEAQnBsB,8BACrByC,EAAYuB,IAAIhE,GAAQwD,IAAI,uBAClC7C,EAAS,CAAE4B,KAAM,SAAU7D,KAAMsB,2CAMjCyC"}